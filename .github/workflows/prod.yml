name: pulumi-dev

on:
  pull_request:
    branches: [ main ]
    types: [ opened, reopened, synchronize, closed ]
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:  
    - uses: actions/checkout@v3
    - name: "Auth to GCP"
      uses: google-github-actions/auth@v0
      with:
        credentials_json: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
    - name: "Node version"
      run: node -v
    - name: "Install NPM requirements"
      run: npm install
    - name: "Get stack settings"
      id: stack
      run: |
        if [ $GITHUB_HEAD_REF ]; then
          NAME=$GITHUB_HEAD_REF
          COMMAND=preview
        else
          case $GITHUB_REF_NAME in
            main)
              NAME=prod
              COMMAND=preview
              ;;
            develop)
              NAME=test
              COMMAND=up
              ;;
            staging)
              NAME=stage
              COMMAND=up
              ;;
          esac
        fi
        echo "::set-output name=NAME::artifactory-$(echo $NAME | tr / - | tr _ -)"
        echo "::set-output name=COMMAND::$COMMAND"
    - name: "Init and up test stack Pulumi"
      if: ${{ github.event.pull_request.opened }} || ${{ github.event.pull_request.reopened }} || ${{ github.event.pull_request.synchronize }}
      id: pulumi
      uses: Moon1706/actions@master
      with:
        command: steps.stack.outputs.COMMAND
        stack-name: steps.stack.outputs.NAME
        cloud-url: gs://pulumi-art
        upsert: ${{ github.event.pull_request.opened }} || ${{ github.event.pull_request.reopened }}
        configMap: |
          artifactory_base_domain:
            value: stg-int.repositories.cloud.sap
            secret: false
          artifactory_domain_prefix:
            value: steps.stack.outputs.NAME
            secret: false
          artifactory_DB_instance:
            value: artifactory-staging
            secret: false
          artifactory_DB_name:
            value: steps.stack.outputs.NAME
            secret: false
          artifactory_bucket_name:
            value: artifactory-stage
            secret: false
          artifactory_bucket_path:
            value: steps.stack.outputs.NAME
            secret: false
      env:
        PULUMI_CONFIG_PASSPHRASE: ""
